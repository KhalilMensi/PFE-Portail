@model PortailEbook.Models.Entity.RechercheViewModel;
@{
    ViewData["Title"] = "Search Page";
}
<style>
    .MaDiv:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease-in-out;
    }

    .icon1:hover {
        fill: #DA4567;
        cursor: pointer;
    }

    .icon2:hover {
        fill: #DA4567;
        cursor: pointer;
    }

    .input-submit .addProduct {
        width: 145px;
        background-color: #ecb43a;
        color: #ffffff;
        font-family: 'poppinslight', sans-serif;
        font-size: 14px;
        border: 0;
        line-height: 14px;
        display: inline-block;
        text-transform: capitalize;
        padding: 15px 0;
        text-align: center;
    }

        .input-submit .addProduct:hover {
            text-decoration: none;
            background-color: #f0f0f0;
            color: #34332f;
        }

    .input-submit .viewDetails {
        text-decoration: none;
        width: 145px;
        background-color: #f0f0f0;
        color: #34332f;
        font-family: 'poppinslight', sans-serif;
        font-size: 14px;
        border: 0;
        line-height: 14px;
        display: inline-block;
        text-transform: capitalize;
        padding: 15px 0;
        text-align: center;
    }

    .input-theme .viewTheme {
        text-decoration: none;
        background-color: #f0f0f0;
        color: #34332f;
        font-family: 'poppinslight', sans-serif;
        font-size: 14px;
        border: 0;
        line-height: 14px;
        text-transform: capitalize;
        padding: 15px 0;
        text-align: center;
        border-radius: 20px;
    }
</style>
<div style="background-color:#f8f9fd;">
    <div class="container mt-4 mb-4">
        <div class="row ">
            <div class="row col-md-12 p-3">
                <p style="font-size:15px">Accueil > Tous les produits > @ViewBag.search</p>
            </div>
            @if (Model == null)
            {
                <div class="row mt-1 mb-1">
                    <h4>Aucun document disponible !!</h4>
                </div>
            }
            else
            {
                if (Model.Themes.Count() > 1)
                {
                    <div class="card row col-md-3 m-1 pb-4 align-content-center" style="height:fit-content;">
                        <div class="row justify-content-center align-content-center">
                            <span class="p-3"><b>Themes</b></span>
                        </div>
                        @foreach (var item in Model.Themes)
                        {
                            <div class="row m-1">
                                <div class="input-theme">
                                    <span class="viewTheme p-2">@item</span>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="container-fluid card col-md-8 m-1">
                        <div class="row col-md-12 pt-2 pb-2">
                            <div class="col-md-10">
                                <span>@Model.Ebooks.Count() Articles</span>
                            </div>
                            <div class="col-md-2" style="display:flex" id="show">

                                <a asp-action="Recherche" asp-route-search="@ViewBag.search" asp-route-mode="Grid" asp-controller="Home" class="col-md-6">
                                    <!--Generated by Fontisto-->
                                    @if (Model.Mode == "Grid")
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" fill="#DA4567" class="icon1" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m9.39 0h5.219v5.219h-5.219z" />
                                            <path d="m17.998 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m9.39 9.39h5.219v5.219h-5.219z" />
                                            <path d="m17.998 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                            <path d="m9.39 18.781h5.219v5.219h-5.219z" />
                                            <path d="m17.998 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" class="icon1" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m9.39 0h5.219v5.219h-5.219z" />
                                            <path d="m17.998 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m9.39 9.39h5.219v5.219h-5.219z" />
                                            <path d="m17.998 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                            <path d="m9.39 18.781h5.219v5.219h-5.219z" />
                                            <path d="m17.998 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }

                                </a>
                                <a asp-action="Recherche" asp-route-search="@ViewBag.search" asp-route-mode="List" asp-controller="Home" class="col-md-6">
                                    <!--Generated by Fontisto-->
                                    @if (Model.Mode == "List")
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" fill="#DA4567" class="icon2" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m7.184 0h20.466v5.219h-20.466z" />
                                            <path d="m7.184 9.39h20.466v5.219h-20.466z" />
                                            <path d="m7.184 18.781h20.466v5.219h-20.466z" />
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" class="icon2" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m7.184 0h20.466v5.219h-20.466z" />
                                            <path d="m7.184 9.39h20.466v5.219h-20.466z" />
                                            <path d="m7.184 18.781h20.466v5.219h-20.466z" />
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }

                                </a>
                            </div>
                        </div>
                        <hr />

                        <div class="row col-md-12 mt-3 mb-3 ">
                            @if (Model.Mode == "Grid")
                            {
                                @foreach (var document in Model.Ebooks)
                                {
                                    <div class="MaDiv col-md-4 text-center p-1">
                                        <div class="item">
                                            <div class="book-wrapper">
                                                <div class="book-bg">
                                                    <a href="#"><img src="~/uploads/CoverPage/@document.CoverPageName" style="width:177px;height:274px"></a>
                                                    <div class="figcaption">
                                                        <div class="search-book">
                                                            <a href="@Url.Action("DetailsEbook", "Ebook", new { id = document.Id })"><i class="icon-loop"></i></a>
                                                        </div>
                                                        <div class="direction-book">
                                                            <a href="#" onclick="addProduct(@document.Id)">
                                                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 5 24 24" width="24px" fill="#FFFFFF">
                                                                    <path d="M0 0h24v24H0z" fill="none" />
                                                                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                                                                </svg>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="book-title">
                                                <h4>@document.OriginalTitle</h4>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                @foreach (var document in Model.Ebooks)
                                {
                                    <div class="MaDiv col-md-12 m-2 p-1">
                                        <div class="row col-md-12">
                                            <div class="col-md-4 p-2">
                                                <a href="#"><img src="~/uploads/CoverPage/@document.CoverPageName" style="width:177px;height:200px"></a>
                                            </div>
                                            <div class="col-md-5 p-2">
                                                <div class="row col-md-12 ">
                                                    <div class="row col-md-12">
                                                        <span style="font-family: 'Roboto', sans-serif;font-size:25px">@document.OriginalTitle</span>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px">Par : <b style="color:#3d84b8">@document.Editor</b></h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px">Année : <b>@document.PublicationDate</b></h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px">Pages : <b>@document.NbPages</b></h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px">Collection : <b>@document.Collection</b></h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px">Price : <b>@document.Price</b> DT</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 p-2">
                                                <div class="input-submit p-2">
                                                    <a href="#" onclick="addProduct(@document.Id)" class="addProduct">Ajouter au Panier</a>
                                                </div>
                                                <div class="input-submit p-2">
                                                    <a href="@Url.Action("DetailsEbook", "Ebook", new { id = document.Id })" target="_blank" class="viewDetails">Voir détailles</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="container-fluid card col-md-12 m-1">
                        <div class="row col-md-12 pt-2 pb-2">
                            <div class="col-md-10">
                                <span>@Model.Ebooks.Count() Articles</span>
                            </div>
                            <div class="col-md-2" style="display:flex" id="show">

                                <a asp-action="Recherche" asp-route-search="@ViewBag.search" asp-route-mode="Grid" asp-controller="Home" class="col-md-6">
                                    <!--Generated by Fontisto-->
                                    @if (Model.Mode == "Grid")
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" fill="#DA4567" class="icon1" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m9.39 0h5.219v5.219h-5.219z" />
                                            <path d="m17.998 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m9.39 9.39h5.219v5.219h-5.219z" />
                                            <path d="m17.998 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                            <path d="m9.39 18.781h5.219v5.219h-5.219z" />
                                            <path d="m17.998 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" class="icon1" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m9.39 0h5.219v5.219h-5.219z" />
                                            <path d="m17.998 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m9.39 9.39h5.219v5.219h-5.219z" />
                                            <path d="m17.998 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                            <path d="m9.39 18.781h5.219v5.219h-5.219z" />
                                            <path d="m17.998 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }

                                </a>
                                <a asp-action="Recherche" asp-route-search="@ViewBag.search" asp-route-mode="List" asp-controller="Home" class="col-md-6">
                                    <!--Generated by Fontisto-->
                                    @if (Model.Mode == "List")
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" fill="#DA4567" class="icon2" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m7.184 0h20.466v5.219h-20.466z" />
                                            <path d="m7.184 9.39h20.466v5.219h-20.466z" />
                                            <path d="m7.184 18.781h20.466v5.219h-20.466z" />
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg viewBox="0 0 20 25" width="20px" height="20px" class="icon2" xmlns="http://www.w3.org/2000/svg">
                                            <path d="m7.184 0h20.466v5.219h-20.466z" />
                                            <path d="m7.184 9.39h20.466v5.219h-20.466z" />
                                            <path d="m7.184 18.781h20.466v5.219h-20.466z" />
                                            <path d="m0 0h5.219v5.219h-5.219z" />
                                            <path d="m0 9.39h5.219v5.219h-5.219z" />
                                            <path d="m0 18.781h5.219v5.219h-5.219z" />
                                        </svg>
                                    }

                                </a>
                            </div>
                        </div>
                        <hr />

                        <div class="row col-md-12 m-1 p-4 justify-content-center align-content-center">
                            @if (Model.Mode == "Grid")
                            {
                                @foreach (var document in Model.Ebooks)
                                {
                                    <div class="MaDiv col-md-4 text-center p-1">
                                        <div class="item">
                                            <div class="book-wrapper">
                                                <div class="book-bg">
                                                    <a href="#"><img src="~/uploads/CoverPage/@document.CoverPageName" style="width:177px;height:274px"></a>
                                                    <div class="figcaption">
                                                        <div class="search-book">
                                                            <a href="@Url.Action("DetailsEbook", "Ebook", new { id = document.Id })"><i class="icon-loop"></i></a>
                                                        </div>
                                                        <div class="direction-book">
                                                            <a href="#" onclick="addProduct(@document.Id)">
                                                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 5 24 24" width="24px" fill="#FFFFFF">
                                                                    <path d="M0 0h24v24H0z" fill="none" />
                                                                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                                                                </svg>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="book-title">
                                                <h4>@document.OriginalTitle</h4>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                @foreach (var document in Model.Ebooks)
                                {
                                    <div class="MaDiv col-md-12">
                                        <div class="row justify-content-center align-content-center">
                                            <div class="p-2" style="width:185px">
                                                <a href="#"><img src="~/uploads/CoverPage/@document.CoverPageName" style="width:177px;height:200px"></a>
                                            </div>
                                            <div class="col-md-7 p-2">
                                                <div class="row col-md-12 ">
                                                    <div class="row col-md-12">
                                                        <span style="font-family: 'Roboto', sans-serif;font-size:25px">@document.OriginalTitle </span>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px;padding-right:3px;"><b style="color:#3d84b8">Par :</b> @document.Editor </h3>
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px"><b style="color:#3d84b8">Année : </b>@document.PublicationDate </h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px;padding-right:3px;"><b style="color:#3d84b8">Pages : </b>@document.NbPages </h3>
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px"><b style="color:#3d84b8">Collection : </b>@document.Collection </h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px;padding-right:3px;"><b style="color:#3d84b8">Price :</b>@document.Price DT</h3>
                                                    </div>
                                                    <div class="row col-md-12">
                                                        <h3 style="font-family: 'Roboto', sans-serif;font-size:15px"><span style="font-family: 'Roboto', sans-serif;font-size:15px"><b style="color:#3d84b8">Description :</b></span>Le lorem ipsum est, en imprimerie, une suite de mots sans signification utilisée à titre provisoire pour calibrer une mise en page, le texte définitif venant remplacer le faux-texte dès qu'il est prêt ou que la mise en page est achevée. </h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-2">
                                                <div class="input-submit p-1">
                                                    <a href="#" onclick="addProduct(@document.Id)" class="addProduct">Ajouter au Panier</a>
                                                </div>
                                                <div class="input-submit p-1">
                                                    <a href="@Url.Action("DetailsEbook", "Ebook", new { id = document.Id })" target="_blank" class="viewDetails">Voir détailles</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>
<script>
    function addProduct(id) {

        var userId;
        var email = AppGlobal.user.Name

        if (email != null && email != "") {
            console.log(email)
            $.ajax({
                url: '/User/getUserId',
                type: 'post',
                dataType: 'json',
                data: {
                    Email: email,
                },
                cache: false,
                success: function (response) {
                    userId = response;
                    addPurchase(userId, id);
                },
                error: function (xhr, error, status) {
                    console.log(error, status);
                }
            });
        } else {
            window.location.href = "/Account/Login"; //will redirect to your blog page (an ex: blog.html)
        }
    }

    function addPurchase(userId, id) {
        var insert = false;
        $.ajax({
            url: '/Purchase/addPurchase',
            type: 'post',
            dataType: 'json',
            data: {
                IdUser: userId, IdDocument: id,
            },
            cache: false,
            success: function (response) {
                if (response.success) {

                    $.ajax({
                        url: '/Purchase/getMax',
                        type: 'get',
                        dataType: 'json',
                        cache: false,
                        success: function (response) {
                            PurchaseId = response;

                            $.ajax({
                                url: '/PurchaseLine/UpsertPurchaseLine',
                                type: 'post',
                                dataType: 'json',
                                data: {
                                    IdPurchase: PurchaseId, IdDocument: id,
                                },
                                cache: false,
                                success: function (response) {

                                    if (AppGlobal.user.role == "User" || AppGlobal.user.role == "Admin") {

                                        $.ajax({
                                            url: '/PurchaseLine/NbPurchaseLine',
                                            type: 'post',
                                            dataType: 'json',
                                            cache: false,
                                            success: function (response) {
                                                $('#NbPurchaseLine').text(response)
                                                $("#dropdown-content").empty()
                                                $.ajax({
                                                    url: '/PurchaseLine/PurchaseLineUser',
                                                    type: 'post',
                                                    dataType: 'json',
                                                    cache: false,
                                                    success: function (response) {
                                                        if (response != null) {
                                                            for (var j = 0; j < response.listDocumentPurchased.length; j++) {
                                                                for (var i = 0; i < response.listPurchaseLine.length; i++) {
                                                                    if (response.listDocumentPurchased[j].id == response.listPurchaseLine[i].idDocument) {
                                                                        $('#dropdown-content').append(`
                                                                            <div class="row justify-content-center align-content-center p-2">
                                                                                <div class="col-md-3 text-center">
                                                                                    <div class="row justify-content-start align-content-center" style="width:80px;">
                                                                                        <img src="${"../../uploads/CoverPage/" + response.listDocumentPurchased[j].coverPageName}" class="col-md-12" style="border-radius: 50%; height:50px">
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-9">
                                                                                    <div class="row justify-content-start align-content-center" style="height:25px">
                                                                                        <span style="font-family: 'Roboto', sans-serif;font-size:15px"><b>${response.listDocumentPurchased[j].originalTitle} </b></span>
                                                                                    </div>
                                                                                    <div class="row justify-content-start align-content-center" style="height:25px">
                                                                                        <span style="font-family: 'Roboto', sans-serif;font-size:12px">${response.listPurchaseLine[i].unitPrice} DT * ${response.listPurchaseLine[i].quantity}</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>`
                                                                        )
                                                                    }
                                                                }
                                                            }
                                                            $('#dropdown-content').append(`
                                                                <div class="row justify-content-center align-content-center p-2">
                                                                    <div class="col-md-12">
                                                                        <div class="row justify-content-start align-content-center" style="height:25px">
                                                                            <span style="font-family: 'Roboto Condensed', sans-serif;font-size:15px;color:coral">
                                                                                <b style="color:#7868e6">Total TTC : </b>${response.purchase.amountTTC} DT
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>`)
                                                        } else {
                                                            $('#dropdown-content').append(`
                                                                <div class="row justify-content-center align-content-center p-2">
                                                                    <div class="col-md-12">
                                                                        <div class="row justify-content-center align-content-center" style="height:25px">
                                                                            <span style="font-family: 'Roboto Condensed', sans-serif;font-size:15px;color:coral">
                                                                                <b>Panier Vide</b>
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>`)
                                                        }
                                                        const Toast = Swal.mixin({
                                                            toast: true,
                                                            position: 'top-end',
                                                            showConfirmButton: false,
                                                            timer: 1000,
                                                            timerProgressBar: true,
                                                            didOpen: (toast) => {
                                                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                                                            }
                                                        })
                                                        Toast.fire({
                                                            icon: 'success',
                                                            title: 'Mise a jours du Panier'
                                                        })
                                                    },
                                                    error: function (xhr, error, status) {
                                                        console.log(error, status);
                                                    }
                                                });
                                            },
                                            error: function (xhr, error, status) {
                                                console.log(error, status);
                                            }
                                        });
                                    }
                                },
                                error: function (xhr, error, status) {
                                    console.log(error, status);
                                }
                            });
                        },
                        error: function (xhr, error, status) {
                            console.log(error, status);
                        }
                    });
                } else {
                    console.log("AddPurchase Failed !")
                }
            },
            error: function (xhr, error, status) {
                console.log(error, status);
            }
        });
    }
</script>
@section Scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}